generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "postgresql"
}
model User {
  id        String   @id @default(ulid()) // ULID
  email     String?  @unique
  name      String?
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  servers    McpServer[]
  reviews    Review[]

  // Better Auth fields
  emailVerified Boolean? @default(false)

  // Better Auth relations
  sessions Session[]
  accounts Account[]
}
model McpServer {
  id        String   @id @default(ulid()) // ULID for internal use
  name      String   // Server name like "ai.smithery/222wcnmibilistalkermcp" - exposed identifier
  version   String   @default("1.0.0") // Server version
  description String?
  category    String?
  maintainerName String?
  maintainerUrl String?
  mcpUrl     String
  documentationUrl String?
  iconUrl    String?
  authenticationType String?
  dynamicClientRegistration Boolean? @default(false)
  isOfficial Boolean? @default(false)
  status     String  @default("pending") // pending, approved, rejected
  mcpStatus  String  @default("active") // MCP status: active, deprecated, deleted
  websiteUrl String?
  schema     String? // $schema URL
  title      String? // server title
  icons      Json?   // array of icon objects
  averageRating Float?
  aiSummary  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  userId    String?
  user      User?     @relation(fields: [userId], references: [id])
  reviews   Review[]
  repository Repository?
  packages  Package[]
  remotes   Remote[]
  publisherMeta Json? // publisher-provided metadata
  officialMeta Json?  // official registry metadata

  // @@unique([name, version]) // Unique constraint on name + version combination - handled in app logic
}

model Repository {
  id        String   @id @default(ulid())
  url       String
  source    String
  repoId    String?  // id field from JSON
  subfolder String?
  serverId  String   @unique
  server    McpServer @relation(fields: [serverId], references: [id], onDelete: Cascade)
}

model Package {
  id                   String   @id @default(ulid())
  registryType         String
  registryBaseUrl      String?
  identifier           String
  version              String
  fileSha256           String?
  runtimeHint          String?
  transport            Json     // stdio, streamable-http, or sse
  runtimeArguments     Json?    // array of arguments
  packageArguments     Json?    // array of arguments
  serverId             String
  server               McpServer @relation(fields: [serverId], references: [id], onDelete: Cascade)
  environmentVariables EnvironmentVariable[]

  @@unique([serverId, registryType, identifier, version])
}

model Remote {
  id          String   @id @default(ulid())
  type        String   // streamable-http or sse
  url         String
  serverId    String
  server      McpServer @relation(fields: [serverId], references: [id], onDelete: Cascade)
  headers     Header[]

  @@unique([serverId, type, url])
}

model EnvironmentVariable {
  id          String   @id @default(ulid())
  name        String
  description String?
  isRequired  Boolean  @default(false)
  isSecret    Boolean  @default(false)
  default     String?
  format      String?  // string, number, boolean, filepath
  choices     Json?    // array of strings
  packageId   String
  package     Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@unique([packageId, name])
}

model Header {
  id          String   @id @default(ulid())
  name        String
  description String?
  isRequired  Boolean  @default(false)
  isSecret    Boolean  @default(false)
  default     String?
  format      String?  // string, number, boolean, filepath
  choices     Json?    // array of strings
  remoteId    String
  remote      Remote   @relation(fields: [remoteId], references: [id], onDelete: Cascade)

  @@unique([remoteId, name])
}
model Review {
  id        String   @id @default(ulid()) // ULID
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  serverId String
  server   McpServer @relation(fields: [serverId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // For anonymous reviews (optional, if allowing anonymous ratings)
  anonymousId String?
}
model Session {
  id        String   @id @default(ulid()) // ULID
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
model Account {
  id                String  @id @default(ulid()) // ULID
  userId            String
  accountId          String
  providerId         String
  accessToken        String?
  refreshToken       String?
  accessTokenExpiresAt DateTime?
  refreshTokenExpiresAt DateTime?
  scope              String?
  idToken            String?
  password           String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}
model Verification {
  id         String   @id @default(ulid()) // ULID
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}
